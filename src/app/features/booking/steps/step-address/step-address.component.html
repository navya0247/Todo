<div class="step-container">
    <div class="header-section">
        <h2>Select Address</h2>
        <p class="subtitle">Where should the expert arrive?</p>
    </div>

    <div *ngIf="isLoading" class="loading-state">
        <div class="spinner"></div>
        <p>Loading addresses...</p>
    </div>

    <div class="content-wrapper" *ngIf="!isLoading">
        <!-- Address List -->
        <div class="address-list" *ngIf="!showAddForm">
            <div class="address-card" *ngFor="let addr of addresses" [class.selected]="selectedAddressId === addr.id"
                (click)="$event.stopPropagation(); selectAddress(addr)">

                <div class="card-icon">
                    <div class="icon-circle">
                        <span>{{ addr.label === 'Home' ? 'üè†' : 'üè¢' }}</span>
                    </div>
                </div>

                <div class="addr-content">
                    <div class="addr-header">
                        <div class="label-group">
                            <span class="addr-label">{{ addr.label }}</span>
                            <span class="property-tag">{{ addr.propertyType || '2 BHK' }}</span>
                        </div>
                    </div>
                    <p class="addr-text">{{ addr.line1 }}</p>
                    <p class="addr-text secondary">{{ addr.city }}, {{ addr.state }} - {{ addr.postalCode }}</p>
                    <p class="addr-phone">üìû {{ addr.phone || addr.contactNumber || '+91 9876543210' }}</p>
                </div>

                <div class="selection-indicator">
                    <div class="check-circle" *ngIf="selectedAddressId === addr.id">
                        <span class="checkmark">‚úì</span>
                    </div>
                </div>
            </div>

            <!-- Add New Button -->
            <button class="btn-add-new-wide" (click)="$event.stopPropagation(); toggleAddForm()">
                <span class="plus">+</span> Add New Address
            </button>

            <!-- Proceed Button (Only shows when an address is selected) -->
            <div class="action-footer" *ngIf="addresses.length > 0">
                <button class="btn-continue" [disabled]="!selectedAddressId" (click)="confirmSelection()">
                    Confirm & Proceed
                </button>
            </div>
        </div>

        <!-- Add Form (Matching Figma media__1770821887618.jpg) -->
        <div class="add-form-premium" *ngIf="showAddForm">
            <div class="form-header-row">
                <h3>Address Details</h3>
                <button class="btn-save-top" (click)="onSubmit()" [disabled]="addressForm.invalid">Save New
                    Address</button>
            </div>

            <form [formGroup]="addressForm" class="figma-form">
                <div class="form-section">
                    <div class="form-row">
                        <div class="field-item full">
                            <label>Service Address <span class="req">*</span></label>
                            <input type="text" formControlName="line1"
                                placeholder="Enter your complete address (House/Flat no., Building, Street, Landmark)">
                        </div>
                    </div>

                    <div class="form-row col-3">
                        <div class="field-item">
                            <label>City <span class="req">*</span></label>
                            <input type="text" formControlName="city" placeholder="e.g., Mumbai">
                        </div>
                        <div class="field-item">
                            <label>State <span class="req">*</span></label>
                            <input type="text" formControlName="state" placeholder="e.g., Maharashtra">
                        </div>
                        <div class="field-item">
                            <label>PIN Code <span class="req">*</span></label>
                            <input type="text" formControlName="postalCode" placeholder="400001">
                        </div>
                    </div>

                    <div class="form-row col-2">
                        <div class="field-item">
                            <label>Contact Name <span class="req">*</span></label>
                            <input type="text" formControlName="contactName" placeholder="Your full name">
                        </div>
                        <div class="field-item">
                            <label>Contact Number <span class="req">*</span></label>
                            <div class="input-with-prefix">
                                <span class="prefix">+91</span>
                                <input type="text" formControlName="contactNumber" placeholder="9876543210">
                            </div>
                        </div>
                    </div>

                    <div class="form-row full">
                        <div class="field-item">
                            <label>Alternate Contact Number (Optional)</label>
                            <div class="input-with-prefix">
                                <span class="prefix">+91</span>
                                <input type="text" formControlName="alternateContactNumber" placeholder="9876543210">
                            </div>
                        </div>
                    </div>

                    <div class="house-type-section">
                        <label class="section-label">üè† House Type</label>
                        <div class="type-selector">
                            <div class="type-btn" *ngFor="let type of ['1 BHK', '2 BHK', '3 BHK', '4 BHK']"
                                [class.active]="addressForm.get('propertyType')?.value === type"
                                (click)="addressForm.get('propertyType')?.setValue(type)">
                                {{ type }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-actions-bottom">
                    <button type="button" class="btn-back" (click)="toggleAddForm()">Back to list</button>
                </div>
            </form>
        </div>
    </div>
</div>